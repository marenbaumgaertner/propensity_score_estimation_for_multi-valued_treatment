---
title: "Fine Tuning results"
author: "Maren Baumg√§rtner"
output: 
  html_notebook:
    toc: true
    toc_float: true
    code_folding: show
---

This notebook uses the result from the fine tuning procedure from the notebook fine_tine.Rmd and simply find the optimal values for the hyperparameters by using either the median or the mode for non-numeric parameters. Note that the `extratrees` splitting rule from the `ranger` probability forest by default uses the whole sample no matter how the input is defined. Therefore, sample is set to 1 if `extratrees` splitting rule is chosen.

```{r}
library(knitr)
library(dplyr)

# Function to calculate mode or mean
get_mode <- function(x) {
  ux <- unique(x)
  ux[which.max(tabulate(match(x, ux)))]
}

convert_to_numeric_if_possible <- function(x) {
  if (all(grepl("^\\d+\\.?\\d*$", x))) { # Check if all elements are numeric
    as.numeric(x)
  } else {
    x
  }
}

```

the `convert_to_numeric_if_possible()` function converts non categorical column into numeric ones as within the list everything is stored as string but to compute the median these need to be numeric.

## Imbens 2016
```{r}
dataname <- "Imbens_2016"
n_iter = 10
results <- readRDS(paste0("sim_results/tuning_results_", dataname, "_", n_iter, "_iterations.rds"))

classifiers_tuned <- names(results[[1]])

final_values <- list()
for (c in classifiers_tuned){
  mat <- matrix(NA, nrow = n_iter, ncol = ncol(results[[1]][[c]]$best_params))

  for (i in 1:n_iter){
    mat[i,] <- as.matrix(results[[i]][[c]]$best_params)
  }
  colnames(mat) <- colnames(as.matrix(results[[i]][[c]]$best_params))

  mat_mean <- as.data.frame(mat) %>%
    mutate_all(~convert_to_numeric_if_possible(.)) %>%
    summarise_all(list(
      median_numeric = ~if(is.numeric(.)) median(.) else get_mode(.)
    ))


  colnames(mat_mean) <- colnames(mat)
  final_values[[c]] <- mat_mean
  
   if (c == "probability_forest_ranger"){
   if (final_values$probability_forest_ranger$splitrule == "extratrees") final_values$probability_forest_ranger$sample.fraction = 1 
  }

  print(kable(as.data.frame(mat), caption = c))
  print(kable(as.data.frame(final_values[[c]]), caption = c))

}
names(final_values) <- classifiers_tuned
saveRDS(final_values, file = paste0("sim_results/final_tuning_results_", dataname, ".rds"))


```

## Linden 2015
```{r}
dataname <- "Linden_2015"
n_iter = 10
results <- readRDS(paste0("sim_results/tuning_results_", dataname, "_", n_iter, "_iterations.rds"))

final_values <- list()
for (c in classifiers_tuned){
  mat <- matrix(NA, nrow = n_iter, ncol = ncol(results[[1]][[c]]$best_params))

  for (i in 1:n_iter){
    mat[i,] <- as.matrix(results[[i]][[c]]$best_params)
  }
  colnames(mat) <- colnames(as.matrix(results[[i]][[c]]$best_params))

  mat_mean <- as.data.frame(mat) %>%
    mutate_all(~convert_to_numeric_if_possible(.)) %>%
    summarise_all(list(
      median_numeric = ~if(is.numeric(.)) median(.) else get_mode(.)
    ))
  

  colnames(mat_mean) <- colnames(mat)
  final_values[[c]] <- mat_mean
  
  if (c == "probability_forest_ranger"){
   if (final_values$probability_forest_ranger$splitrule == "extratrees") final_values$probability_forest_ranger$sample.fraction = 1 
  }
  
  print(kable(as.data.frame(mat), caption = c))
  print(kable(as.data.frame(final_values[[c]]), caption = c))

}


names(final_values) <- classifiers_tuned
saveRDS(final_values, file = paste0("sim_results/final_tuning_results_", dataname, ".rds"))

```

## Acharky 2023
```{r}
dataname <- "Acharky_2023"
n_iter = 10
results <- readRDS(paste0("sim_results/tuning_results_", dataname, "_", n_iter, "_iterations.rds"))

final_values <- list()
for (c in classifiers_tuned){
  mat <- matrix(NA, nrow = n_iter, ncol = ncol(results[[1]][[c]]$best_params))

  for (i in 1:n_iter){
    mat[i,] <- as.matrix(results[[i]][[c]]$best_params)
  }
  colnames(mat) <- colnames(as.matrix(results[[i]][[c]]$best_params))

  mat_mean <- as.data.frame(mat) %>%
    mutate_all(~convert_to_numeric_if_possible(.)) %>%
    summarise_all(list(
      median_numeric = ~if(is.numeric(.)) median(.) else get_mode(.)
    ))


  colnames(mat_mean) <- colnames(mat)
  final_values[[c]] <- mat_mean
  
   if (c == "probability_forest_ranger"){
   if (final_values$probability_forest_ranger$splitrule == "extratrees") final_values$probability_forest_ranger$sample.fraction = 1 
  }

  print(kable(as.data.frame(mat), caption = c))
  print(kable(as.data.frame(final_values[[c]]), caption = c))

}
names(final_values) <- classifiers_tuned
saveRDS(final_values, file = paste0("sim_results/final_tuning_results_", dataname, ".rds"))

```
